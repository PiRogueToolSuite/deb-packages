flush ruleset

define iface_uplink = ETH_IFACE
define iface_device = WLAN_IFACE

table inet filter {
    chain global {
        # Allow from loopback
        iifname lo accept comment "Allow traffic to localhost"
        oifname "lo" accept comment "Allow traffic from localhost"

        # Allow established connections
        ct state {established, related} accept

        # Early drop of invalid connections
        ct state invalid drop
    }

    chain icmp_chain {
        ip protocol icmp icmp type {destination-unreachable} accept
        ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, nd-neighbor-solicit, nd-router-advert, nd-neighbor-advert } accept
    }


    chain input {
        type filter hook input priority 0

        # Apply global rules
        jump global
        jump icmp_chain
        
        iifname $iface_device udp dport {67, 68} accept comment "Allow DHCP requests from Wi-Fi"
        iifname $iface_device udp dport 53 accept comment "Allow DNS requests from Wi-Fi"

        iifname $iface_uplink accept comment "Allow access to this machine on all ports via LAN iface"
        
        meta nftrace set 1
        counter reject
    }

    chain forward {
        type filter hook forward priority 0;
        
        # Apply global rules
        jump global
        jump icmp_chain

        iifname $iface_device oifname $iface_uplink udp dport {80, 443} reject with icmpx port-unreachable comment "Reject QUIC requests from Wi-Fi"
        iifname $iface_device oifname $iface_uplink ip daddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } reject with icmpx port-unreachable comment "Reject access to LAN from Wi-Fi"
        iifname $iface_device oifname $iface_uplink accept comment "Allow forward from Wi-Fi to uplink"

        meta nftrace set 1
        counter reject
    }

    chain output {
        type filter hook output priority 0;

        # Apply global rules
        jump global
        jump icmp_chain
        oifname $iface_uplink accept comment "Allow the PiRogue to reach any ports on LAN"
        oifname $iface_device udp sport 67 udp dport 68 accept comment "Allow DHCP answers from PiRogue to Wi-Fi"

        meta nftrace set 1
        counter reject
    }
}

table inet nat {
    chain global {
        # Allow from loopback
        iifname lo accept comment "Allow traffic to localhost"
        oifname "lo" accept comment "Allow traffic from localhost"

        # Allow established connections
        ct state {established, related} accept

        # Early drop of invalid connections
        ct state invalid drop
    }
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        jump global
        oifname $iface_uplink counter masquerade
        counter
    }
    
    chain prerouting {
        type nat hook prerouting priority 100; policy accept;
        jump global
        counter
    } 
}
